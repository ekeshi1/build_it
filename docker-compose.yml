version: "2"
services:
  
  db:
    build:
      context: .
      dockerfile: Dockerfile.postgres # Big THX to Amir.SH!!! for simplifiying DB initialization
    restart: always
    environment:
      POSTGRES_USER: "postgres"
      POSTGRES_PASSWORD: "postgres"
      POSTGRES_DB: "postgres"
    ports:
      - "5432:5432"
  buildit-test:
    build: 
      context: .
      dockerfile: test/Dockerfile
    command: "go test ./test/..."


  buildit:  
    build: . # uses Dockerfile in root dir to build the image
    ports:
      - "8081:8080"

    environment:
      #KAFKA_URL: kafka:9092
      POSTGRES_USER: "postgres"
      POSTGRES_PASSWORD: "postgres"
      POSTGRES_DB: "postgres"
      POSTGRES_HOST: db
      POSTGRES_PORT: "5432"
    restart: on-failure  
    #depends_on: [postgres,kafka,zookeeper]   
    depends_on: [db]   

    #links: [kafka,zookeeper]

